name: Auto Build Termux for SpineViewer

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  build-termux-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Get Latest Tag from Upstream
        id: upstream
        run: |
          UPSTREAM_TAG=$(curl -s https://api.github.com/repos/ww-rm/SpineViewer/releases/latest | jq -r .tag_name)
          echo "tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT

      - name: Checkout Upstream Code
        uses: actions/checkout@v4
        with:
          repository: ww-rm/SpineViewer
          ref: ${{ steps.upstream.outputs.tag }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in ARM64 Container (.NET 9)
        run: |
          mkdir -p dist/termux
          
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            mcr.microsoft.com/dotnet/sdk:9.0 \
            bash -c "
              sed -i 's/net8.0/net9.0/g' SpineViewerCLI/SpineViewerCLI.csproj
              
              dotnet publish SpineViewerCLI/SpineViewerCLI.csproj \
                -c Release \
                -r linux-arm64 \
                --self-contained false \
                -p:PublishSingleFile=false \
                -p:PublishTrimmed=false \
                -o dist/termux
              
              echo '#!/bin/bash' > dist/termux/run.sh
              echo 'export LD_PRELOAD=\"\"' >> dist/termux/run.sh
              echo 'dotnet SpineViewerCLI.dll \"\$@\"' >> dist/termux/run.sh
              chmod +x dist/termux/run.sh
              
              chmod -R 777 dist/termux
            "

      - name: Package Release
        run: |
          cd dist/termux
          zip -r ../../SpineViewerCLI-Termux-ARM64.zip *

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.upstream.outputs.tag }}
          name: Release ${{ steps.upstream.outputs.tag }} 
          files: SpineViewerCLI-Termux-ARM64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
