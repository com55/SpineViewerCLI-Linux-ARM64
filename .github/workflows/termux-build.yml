name: Auto Build Termux (Docker Native)

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  build-termux-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Get Latest Tag from Upstream
        id: upstream
        run: |
          UPSTREAM_TAG=$(curl -s https://api.github.com/repos/ww-rm/SpineViewer/releases/latest | jq -r .tag_name)
          echo "tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT

      - name: Checkout Upstream Code
        uses: actions/checkout@v4
        with:
          repository: ww-rm/SpineViewer
          ref: ${{ steps.upstream.outputs.tag }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in Termux Container
        run: |
          mkdir -p dist/termux
          
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            termux/termux-docker:latest \
            bash -c "
              echo 'Setting up Termux Environment...'
              pkg update -y && pkg install -y wget tar openssl libicu krb5 zlib
              
              wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
              chmod +x dotnet-install.sh
              ./dotnet-install.sh --channel 8.0 --install-dir /root/.dotnet
              export PATH=\$PATH:/root/.dotnet
              
              echo 'Building Project...'
              dotnet publish SpineViewerCLI/SpineViewerCLI.csproj \
                -c Release \
                -r linux-arm64 \
                --self-contained true \
                -p:PublishSingleFile=true \
                -p:EnableCompressionInSingleFile=false \
                -p:IncludeNativeLibrariesForSelfExtract=true \
                -o /workspace/dist/termux
 
              chmod -R 777 /workspace/dist/termux
            "

      - name: Package Release
        run: |
          cd dist/termux
          ls -lh
          zip -r ../../SpineViewerCLI-Termux-ARM64.zip *

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.upstream.outputs.tag }}
          name: Release ${{ steps.upstream.outputs.tag }} 
          files: SpineViewerCLI-Termux-ARM64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
