name: Auto Build ARM64 for SpineViewer

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force rebuild even if release exists'
        required: false
        type: boolean
        default: true

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Get Latest Tag from Upstream
        id: upstream
        run: |
          UPSTREAM_TAG=$(curl -s https://api.github.com/repos/ww-rm/SpineViewer/releases/latest | jq -r .tag_name)
          echo "tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT

      - name: Check if Release Already Exists
        id: check_rel
        run: |
          MY_REL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream.outputs.tag }} | jq -r .tag_name)
          if [ "$MY_REL" == "${{ steps.upstream.outputs.tag }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine if Should Build
        id: should_build
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.force_build }}" == "true" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
            echo "Manual run with force_build enabled - will rebuild"
          elif [ "${{ steps.check_rel.outputs.exists }}" == "false" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
            echo "Release doesn't exist - will build"
          else
            echo "build=false" >> $GITHUB_OUTPUT
            echo "Release exists and not forced - skipping build"
          fi

      - name: Delete Existing Release Asset if Force Build
        if: steps.should_build.outputs.build == 'true' && steps.check_rel.outputs.exists == 'true'
        run: |
          ASSET_ID=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream.outputs.tag }} | jq -r '.assets[] | select(.name=="SpineViewerCLI-Linux-ARM64.zip") | .id')
          if [ -n "$ASSET_ID" ] && [ "$ASSET_ID" != "null" ]; then
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID
            echo "Deleted existing asset"
          fi
          
      - name: Checkout Upstream Code
        if: steps.should_build.outputs.build == 'true'
        uses: actions/checkout@v4
        with:
          repository: ww-rm/SpineViewer
          ref: ${{ steps.upstream.outputs.tag }}

      - name: Set up QEMU
        if: steps.should_build.outputs.build == 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in Docker with Dependencies
        if: steps.should_build.outputs.build == 'true'
        run: |
          cat > Dockerfile.arm64 << 'EOF'
          FROM --platform=linux/arm64 mcr.microsoft.com/dotnet/sdk:8.0
          
          # Install dependencies
          RUN apt-get update && apt-get install -y \
              uuid-dev \
              patchelf \
              zip \
              && rm -rf /var/lib/apt/lists/*
          
          WORKDIR /build
          COPY . .
          
          # Don't patch - use regular SkiaSharp
          RUN dotnet publish SpineViewerCLI/SpineViewerCLI.csproj \
              -c Release \
              -r linux-arm64 \
              --self-contained true \
              /p:PublishSingleFile=false \
              /p:PublishTrimmed=false \
              /p:PlatformTarget=ARM64 \
              -o /output
          
          # Bundle libuuid with the app
          RUN cp /usr/lib/aarch64-linux-gnu/libuuid.so.1* /output/ || \
              cp /lib/aarch64-linux-gnu/libuuid.so.1* /output/ || \
              find /usr/lib -name "libuuid.so.1*" -exec cp {} /output/ \; || \
              find /lib -name "libuuid.so.1*" -exec cp {} /output/ \; || \
              echo "Warning: libuuid not found"
          
          # Create symlink if needed
          RUN cd /output && \
              if [ -f libuuid.so.1.* ] && [ ! -f libuuid.so.1 ]; then \
                ln -s libuuid.so.1.* libuuid.so.1; \
              fi
          
          # Patch RPATH for all .so files to look in current directory
          RUN find /output -name "*.so*" -type f -exec patchelf --set-rpath '$ORIGIN' {} \; 2>/dev/null || true
          
          # Patch the main executable to look in current directory for libraries
          RUN patchelf --set-rpath '$ORIGIN' /output/SpineViewerCLI 2>/dev/null || true
          
          # Verify RPATH is set correctly
          RUN echo "=== Checking RPATH ===" && \
              patchelf --print-rpath /output/SpineViewerCLI || echo "No RPATH for SpineViewerCLI" && \
              (patchelf --print-rpath /output/libSkiaSharp.so || echo "No RPATH for SkiaSharp") && \
              echo "=== Checking libuuid ===" && \
              ls -la /output/libuuid* || echo "No libuuid found"
          
          WORKDIR /output
          RUN zip -r /SpineViewerCLI-Linux-ARM64.zip .
          EOF
          
          docker buildx build --platform linux/arm64 -f Dockerfile.arm64 -t spineviewer-arm64 --load .
          docker run --rm -v $(pwd):/out spineviewer-arm64 cp /SpineViewerCLI-Linux-ARM64.zip /out/

      - name: Upload to Existing Release
        if: steps.should_build.outputs.build == 'true' && steps.check_rel.outputs.exists == 'true'
        run: |
          RELEASE_ID=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream.outputs.tag }} | jq -r .id)
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/zip" \
            --data-binary @SpineViewerCLI-Linux-ARM64.zip \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=SpineViewerCLI-Linux-ARM64.zip"

      - name: Create New Release
        if: steps.should_build.outputs.build == 'true' && steps.check_rel.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.upstream.outputs.tag }}
          name: Release ${{ steps.upstream.outputs.tag }}
          body: |
            Release ${{ steps.upstream.outputs.tag }}
            **Usage:**
            ```bash
                        unzip SpineViewerCLI-Linux-ARM64.zip
                        ./SpineViewerCLI [arguments]
            ```
          files: SpineViewerCLI-Linux-ARM64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
