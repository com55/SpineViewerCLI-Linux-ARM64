name: Auto Build ARM64 for SpineViewer

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force rebuild even if release exists'
        required: false
        type: boolean
        default: true

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Get Latest Tag from Upstream
        id: upstream
        run: |
          UPSTREAM_TAG=$(curl -s https://api.github.com/repos/ww-rm/SpineViewer/releases/latest | jq -r .tag_name)
          echo "tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT

      - name: Check if Release Already Exists
        id: check_rel
        run: |
          MY_REL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream.outputs.tag }} | jq -r .tag_name)
          if [ "$MY_REL" == "${{ steps.upstream.outputs.tag }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine if Should Build
        id: should_build
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.force_build }}" == "true" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
            echo "Manual run with force_build enabled - will rebuild"
          elif [ "${{ steps.check_rel.outputs.exists }}" == "false" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
            echo "Release doesn't exist - will build"
          else
            echo "build=false" >> $GITHUB_OUTPUT
            echo "Release exists and not forced - skipping build"
          fi

      - name: Delete Existing Release Asset if Force Build
        if: steps.should_build.outputs.build == 'true' && steps.check_rel.outputs.exists == 'true'
        run: |
          ASSET_ID=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream.outputs.tag }} | jq -r '.assets[] | select(.name=="SpineViewerCLI-Linux-ARM64.zip") | .id')
          if [ -n "$ASSET_ID" ] && [ "$ASSET_ID" != "null" ]; then
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID
            echo "Deleted existing asset"
          fi
          
      - name: Checkout Upstream Code
        if: steps.should_build.outputs.build == 'true'
        uses: actions/checkout@v4
        with:
          repository: ww-rm/SpineViewer
          ref: ${{ steps.upstream.outputs.tag }}

      - name: Set up Docker Buildx
        if: steps.should_build.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        if: steps.should_build.outputs.build == 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Cache Docker layers
        if: steps.should_build.outputs.build == 'true'
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-arm64-${{ hashFiles('**/SpineViewerCLI.csproj') }}
          restore-keys: |
            ${{ runner.os }}-buildx-arm64-

      - name: Build in Docker with Dependencies
        if: steps.should_build.outputs.build == 'true'
        run: |
          cat > Dockerfile.arm64 << 'EOF'
          FROM --platform=linux/arm64 mcr.microsoft.com/dotnet/sdk:8.0
          
          # Install dependencies
          RUN apt-get update && apt-get install -y \
              uuid-dev \
              patchelf \
              zip \
              && rm -rf /var/lib/apt/lists/*
          
          WORKDIR /build
          COPY . .
          
          # Build without patching SkiaSharp reference
          RUN dotnet publish SpineViewerCLI/SpineViewerCLI.csproj \
              -c Release \
              -r linux-arm64 \
              --self-contained true \
              /p:PublishSingleFile=false \
              /p:PublishTrimmed=false \
              /p:PlatformTarget=ARM64 \
              -o /output
          
          # Copy libuuid to multiple locations for maximum compatibility
          RUN cp /usr/lib/aarch64-linux-gnu/libuuid.so.1* /output/ 2>/dev/null || \
              cp /lib/aarch64-linux-gnu/libuuid.so.1* /output/ 2>/dev/null || \
              find /usr/lib -name "libuuid.so.1*" -exec cp {} /output/ \; 2>/dev/null || \
              find /lib -name "libuuid.so.1*" -exec cp {} /output/ \; 2>/dev/null
          
          # Create symlinks for libuuid
          RUN cd /output && \
              for f in libuuid.so.1.*; do \
                if [ -f "$f" ]; then \
                  ln -sf "$f" libuuid.so.1 2>/dev/null || true; \
                  ln -sf "$f" libuuid.so 2>/dev/null || true; \
                  break; \
                fi; \
              done
          
          # AGGRESSIVE RPATH PATCHING - patch every single .so file
          RUN echo "=== Patching all libraries ===" && \
              find /output -type f \( -name "*.so" -o -name "*.so.*" \) -exec sh -c '\
                echo "Processing: {}"; \
                patchelf --set-rpath "\$ORIGIN:\$ORIGIN/lib" "{}" 2>/dev/null || true; \
                patchelf --print-rpath "{}" 2>/dev/null || echo "  No RPATH set"; \
              ' \;
          
          # Patch the main executable with multiple fallback paths
          RUN echo "=== Patching main executable ===" && \
              patchelf --set-rpath '$ORIGIN:$ORIGIN/lib:/lib:/usr/lib' /output/SpineViewerCLI 2>/dev/null || true && \
              patchelf --print-rpath /output/SpineViewerCLI 2>/dev/null || echo "No RPATH for executable"
          
          # VERIFICATION - check everything is correct
          RUN echo "=== VERIFICATION START ===" && \
              echo "--- Files in output ---" && \
              ls -lh /output/ | head -20 && \
              echo "--- libuuid files ---" && \
              ls -la /output/libuuid* && \
              echo "--- libSkiaSharp.so RPATH ---" && \
              (patchelf --print-rpath /output/libSkiaSharp.so || echo "NO RPATH") && \
              echo "--- libSkiaSharp.so dependencies ---" && \
              (ldd /output/libSkiaSharp.so 2>/dev/null | grep -E "uuid|not found" || echo "ldd not available") && \
              echo "--- SpineViewerCLI RPATH ---" && \
              (patchelf --print-rpath /output/SpineViewerCLI || echo "NO RPATH") && \
              echo "=== VERIFICATION END ==="
          
          WORKDIR /output
          RUN zip -r /SpineViewerCLI-Linux-ARM64.zip .
          EOF
          
          docker buildx build \
            --platform linux/arm64 \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -f Dockerfile.arm64 \
            -t spineviewer-arm64 \
            --load \
            .
          
          docker run --rm -v $(pwd):/out spineviewer-arm64 cp /SpineViewerCLI-Linux-ARM64.zip /out/
          
          # Move cache
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Upload to Existing Release
        if: steps.should_build.outputs.build == 'true' && steps.check_rel.outputs.exists == 'true'
        run: |
          RELEASE_ID=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream.outputs.tag }} | jq -r .id)
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/zip" \
            --data-binary @SpineViewerCLI-Linux-ARM64.zip \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=SpineViewerCLI-Linux-ARM64.zip"

      - name: Create New Release
        if: steps.should_build.outputs.build == 'true' && steps.check_rel.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.upstream.outputs.tag }}
          name: Release ${{ steps.upstream.outputs.tag }}
          body: |
            Release ${{ steps.upstream.outputs.tag }}
            **Usage:**
            ```bash
              unzip SpineViewerCLI-Linux-ARM64.zip
              ./SpineViewerCLI [arguments]
            ```
          files: SpineViewerCLI-Linux-ARM64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
